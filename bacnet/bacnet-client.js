"use strict";function _createForOfIteratorHelper(e,t){var n,r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return r&&(e=r),n=0,{s:t=function(){},n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){a=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}module.exports=function(t){var n=require("./core/bacnet-core"),r=require("node-bacnet");t.nodes.registerType("BACnet-Client",function(e){t.nodes.createNode(this,e),this.name=e.name,this.adpuTimeout=parseInt(e.adpuTimeout)||6e3,this.port=parseInt(e.port)||47808,this.interface=e.interface||"0.0.0.0",this.broadcastAddress=e.broadcastAddress||"0.0.0.255";var i=this;i.devices=[],i.nmap={},i.pendingResolution={},function t(){i.client=new r({adpuTimeout:i.adpuTimeout,port:i.port,interface:i.interface,broadcastAddress:i.broadcastAddress}),i.client.on("iAm",function(e){i.devices.push(e),n.internalDebugLog("iAm Event",e),i.cacheDeviceAddress(e)}),i.client.on("timeout",function(){n.internalDebugLog("timeout")}),i.client.whoIs({net:65535}),i.client.on("error",function(e){i.error(e,{payload:"BACnet Client Error"}),i.client.close(),i.client=null,i.devices=[],t()})}(),i.on("input",function(e){e.devices=i.devices,i.send(e)}),i.on("close",function(e){i.client&&(i.client.close(),i.client=null),e()}),i.whoIsExplicit=function(e,t,n,r){i.devices=[],i.client.whoIs({net:65535,address:n},{lowLimit:e,highLimit:t}),setTimeout(r,3e3)},i.whoIs=function(e){i.devices=[],i.client.whoIs({net:65535}),setTimeout(e,3e3)},i.cacheDeviceAddress=function(e){var t=e.payload.deviceId,e=e.header.sender,n={address:e.address,net:e.net,adr:e.adr,lastUpdated:Date.now()};if(i.nmap[t]=n,t in i.pendingResolution){var r,e=i.pendingResolution[t],o=(delete i.pendingResolution[t],_createForOfIteratorHelper(e));try{for(o.s();!(r=o.n()).done;)(0,r.value)(n)}catch(e){o.e(e)}finally{o.f()}}},i.getDeviceAddressById=function(e,t,n){e in i.nmap?t(i.nmap[e]):(console.log("getDeviceAddressById cache miss",e),1===(i.pendingResolution[e]=i.pendingResolution[e]||[]).push(t)&&(i.client.whoIs({net:65535},{lowLimit:e,highLimit:e}),setTimeout(function(){e in i.pendingResolution&&(console.error("getDeviceAddressById timeout",e),delete i.pendingResolution[e],n&&n())},i.adpuTimeout)))}})};
//# sourceMappingURL=maps/bacnet-client.js.map
