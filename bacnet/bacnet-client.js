"use strict";function _createForOfIteratorHelper(e,t){var n,r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return r&&(e=r),n=0,{s:t=function(){},n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){a=!0,i=e},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw i}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}module.exports=function(t){var n=require("./core/bacnet-core"),r=require("node-bacnet");t.nodes.registerType("BACnet-Client",function(e){t.nodes.createNode(this,e),this.name=e.name,this.adpuTimeout=parseInt(e.adpuTimeout)||6e3,this.port=parseInt(e.port)||47808,this.interface=e.interface||"0.0.0.0",this.broadcastAddress=e.broadcastAddress||"0.0.0.255";var o=this;o.devices=[],o.nmap={},o.pendingResolution={},function t(){o.client=new r({adpuTimeout:o.adpuTimeout,port:o.port,interface:o.interface,broadcastAddress:o.broadcastAddress}),o.client.on("iAm",function(e){o.devices.push(e),n.internalDebugLog("iAm Event",e),o.cacheDeviceAddress(e)}),o.client.on("timeout",function(){n.internalDebugLog("timeout")}),o.client.whoIs(),o.client.on("error",function(e){o.error(e,{payload:"BACnet Client Error"}),o.client.close(),o.client=null,o.devices=[],t()})}(),o.on("input",function(e){e.devices=o.devices,o.send(e)}),o.on("close",function(e){o.client&&(o.client.close(),o.client=null),e()}),o.whoIsExplicit=function(e,t,n,r){o.devices=[],o.client.whoIs({lowLimit:e,highLimit:t,deviceIPAddress:n}),setTimeout(r,3e3)},o.whoIs=function(e){o.devices=[],o.client.whoIs(),setTimeout(e,3e3)},o.cacheDeviceAddress=function(e){var t=e.payload.deviceId,e=e.header.sender,n={address:e.address,net:e.net,adr:e.adr,lastUpdated:Date.now()};if(o.nmap[t]=n,t in o.pendingResolution){var r,e=o.pendingResolution[t],i=(delete o.pendingResolution[t],_createForOfIteratorHelper(e));try{for(i.s();!(r=i.n()).done;)(0,r.value)(n)}catch(e){i.e(e)}finally{i.f()}}},o.getDeviceAddressById=function(e,t){e in o.nmap?t(o.nmap[e]):(console.log("getDeviceAddressById cache miss",e),1===(o.pendingResolution[e]=o.pendingResolution[e]||[]).push(t)&&o.client.whoIs({lowLimit:e,highLimit:e}))}})};
//# sourceMappingURL=maps/bacnet-client.js.map
